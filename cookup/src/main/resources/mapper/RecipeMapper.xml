<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lzkydh.mapper.RecipeMapper">

    <insert id="addRecipe" parameterType="Recipe" keyProperty="recipeId">
        insert into recipe(user_id,recipe_name,pic_url,material,profile)
        value(#{userId},#{recipeName},#{picUrl},#{material},#{profile})
    </insert>

    <delete id="deleteRecipeByRecipeId">
        delete from recipe
        where recipe_id = #{recipeId}
    </delete>

    <update id="updateRecipe" parameterType="Recipe">
        update recipe set
          user_id = #{userId},
          recipe_name = #{recipeName},
          pic_url = #{picUrl},
          material = #{material},
          profile = #{profile}
        where recipe_id = #{recipeId}
    </update>

    <resultMap type="Recipe" id="recipeMap">
        <id property="recipeId" column="recipe_id"/>
        <result property="userId" column="user_id"/>
        <result property="recipeName" column="recipe_name"/>
        <result property="picUrl" column="pic_url"/>
        <result property="material" column="material"/>
        <result property="profile" column="profile"/>
        <association property="user" javaType="User">
            <id property="userId" column="user_id"/>
            <result property="username" column="username"/>
        </association>
        <collection property="labels" ofType="Label">
            <id property="labelId" column="label_id"/>
            <result property="labelMark" column="label_mark"/>
            <result property="labelName" column="label_name"/>
            <result property="searchTimes" column="search_times"/>
        </collection>
    </resultMap>

    <sql id="selectSql">
        select
          r.recipe_id,
          r.user_id,
          r.recipe_name,
          r.pic_url,
          r.material,
          r.profile,
          l.label_id,
          l.label_mark,
          l.label_name,
          l.search_times,
          u.username
        from recipe r
        inner join recipe_label rl
        on r.recipe_id = rl.recipe_id
        inner join label l
        on rl.label_id = l.label_id
        inner join user u
        on r.user_id = u.user_id
    </sql>

    <select id="queryByRecipeId" resultMap="recipeMap">
        <include refid="selectSql"></include>
        where  r.recipe_id = #{recipeId}
    </select>

    <select id="queryByUserId" resultMap="recipeMap">
        <include refid="selectSql"></include>
        where  u.user_id = #{userId}
    </select>
    <select id="queryByLabelName" resultMap="recipeMap" parameterType="String">
        <include refid="selectSql"></include>
        where  l.label_name in
        <foreach collection="labelNames" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

</mapper>